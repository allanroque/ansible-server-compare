---
- name: Check which server JSON files exist
  ansible.builtin.stat:
    path: "reports/{{ item }}_info.json"
  register: server_files_check
  loop: "{{ groups['servers'] }}"
  delegate_to: localhost

- name: Display server file status
  ansible.builtin.debug:
    msg: |
      Servidores com arquivos JSON:
      {% for result in server_files_check.results %}
      {% if result.stat.exists %}
      âœ… {{ result.item }}: {{ result.stat.path }}
      {% else %}
      âŒ {{ result.item }}: Arquivo nÃ£o encontrado
      {% endif %}
      {% endfor %}
  delegate_to: localhost

- name: Load server information from JSON files
  ansible.builtin.slurp:
    src: "reports/{{ item }}_info.json"
  register: server_data
  loop: "{{ groups['servers'] }}"
  delegate_to: localhost
  ignore_errors: true

- name: Debug loaded data
  ansible.builtin.debug:
    msg: |
      Dados carregados:
      {% for result in server_data.results %}
      {% if result.failed %}
      âŒ {{ result.item }}: {{ result.msg }}
      {% elif result.content is defined %}
      âœ… {{ result.item }}: Dados carregados com sucesso
      {% else %}
      âŒ {{ result.item }}: Estrutura inesperada
      {% endif %}
      {% endfor %}
  delegate_to: localhost
  when: server_data is defined and server_data.results is defined

- name: Parse server information
  ansible.builtin.set_fact:
    servers_info: "{{ servers_info | default({}) | combine({item.item: (item.content | b64decode | from_json)}) }}"
  loop: "{{ server_data.results | rejectattr('failed') | list }}"
  delegate_to: localhost
  when: server_data is defined and server_data.results is defined

- name: Generate comparison data
  ansible.builtin.set_fact:
    comparison_data:
      servers: "{{ servers_info | default({}) }}"
      server_count: "{{ servers_info | length }}"
      common_packages: "{{ (servers_info.values() | map(attribute='packages_info.rpm_packages') | list | first | default([])) }}"
      common_services: "{{ (servers_info.values() | map(attribute='services_info.systemd_running') | list | first | default([])) }}"
      different_packages: []
      different_services: []
      analysis_note: "{% if servers_info | length == 1 %}AnÃ¡lise de servidor Ãºnico - nÃ£o hÃ¡ comparaÃ§Ã£o disponÃ­vel{% else %}ComparaÃ§Ã£o entre {{ servers_info | length }} servidores{% endif %}"
  delegate_to: localhost
  when: servers_info is defined

- name: Save comparison data
  ansible.builtin.copy:
    content: "{{ comparison_data | to_nice_json }}"
    dest: "reports/comparison_data.json"
    mode: '0644'
  delegate_to: localhost
  when: comparison_data is defined

- name: Display comparison summary
  ansible.builtin.debug:
    msg: |
      ========================================
      RESUMO DA COMPARAÃ‡ÃƒO
      ========================================
      
      {% if comparison_data is defined %}
      âœ… ComparaÃ§Ã£o gerada com sucesso!
      ğŸ“Š Servidores processados: {{ comparison_data.server_count }}
      ğŸ“ {{ comparison_data.analysis_note }}
      ğŸ“¦ Pacotes encontrados: {{ comparison_data.common_packages | length }}
      âš™ï¸ ServiÃ§os encontrados: {{ comparison_data.common_services | length }}
      ğŸ“ Arquivo salvo: reports/comparison_data.json
      {% else %}
      âŒ Nenhum servidor foi processado com sucesso
      ğŸ” Verifique se os arquivos JSON foram gerados corretamente
      {% endif %}
      
      ========================================
  delegate_to: localhost
