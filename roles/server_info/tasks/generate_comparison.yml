---
- name: Check which server JSON files exist
  ansible.builtin.stat:
    path: "reports/{{ item }}_info.json"
  register: server_files_check
  loop: "{{ groups['servers'] }}"
  delegate_to: localhost

- name: Display server file status
  ansible.builtin.debug:
    msg: |
      Servidores com arquivos JSON:
      {% for result in server_files_check.results %}
      {% if result.stat.exists %}
      ✅ {{ result.item }}: {{ result.stat.path }}
      {% else %}
      ❌ {{ result.item }}: Arquivo não encontrado
      {% endif %}
      {% endfor %}
  delegate_to: localhost

- name: Load server information from JSON files
  ansible.builtin.slurp:
    src: "reports/{{ item }}_info.json"
  register: server_data
  loop: "{{ groups['servers'] }}"
  delegate_to: localhost
  ignore_errors: true

- name: Debug loaded data
  ansible.builtin.debug:
    msg: |
      Dados carregados:
      {% for result in server_data.results %}
      {% if result.failed %}
      ❌ {{ result.item }}: {{ result.msg }}
      {% elif result.content is defined %}
      ✅ {{ result.item }}: Dados carregados com sucesso
      {% else %}
      ❌ {{ result.item }}: Estrutura inesperada
      {% endif %}
      {% endfor %}
  delegate_to: localhost
  when: server_data is defined and server_data.results is defined

- name: Parse server information
  ansible.builtin.set_fact:
    servers_info: "{{ servers_info | default({}) | combine({item.item: (item.content | b64decode | from_json)}) }}"
  loop: "{{ server_data.results | rejectattr('failed') | list }}"
  delegate_to: localhost
  when: server_data is defined and server_data.results is defined

- name: Generate comparison data
  ansible.builtin.set_fact:
    comparison_data:
      servers: "{{ servers_info | default({}) }}"
      server_count: "{{ servers_info | length }}"
      common_packages: "{{ (servers_info.values() | map(attribute='packages_info.rpm_packages') | list | first | default([])) }}"
      common_services: "{{ (servers_info.values() | map(attribute='services_info.systemd_running') | list | first | default([])) }}"
      different_packages: []
      different_services: []
      analysis_note: "{% if servers_info | length == 1 %}Análise de servidor único - não há comparação disponível{% else %}Comparação entre {{ servers_info | length }} servidores{% endif %}"
  delegate_to: localhost
  when: servers_info is defined

- name: Save comparison data
  ansible.builtin.copy:
    content: "{{ comparison_data | to_nice_json }}"
    dest: "reports/comparison_data.json"
    mode: '0644'
  delegate_to: localhost
  when: comparison_data is defined

- name: Display comparison summary
  ansible.builtin.debug:
    msg: |
      ========================================
      RESUMO DA COMPARAÇÃO
      ========================================
      
      {% if comparison_data is defined %}
      ✅ Comparação gerada com sucesso!
      📊 Servidores processados: {{ comparison_data.server_count }}
      📝 {{ comparison_data.analysis_note }}
      📦 Pacotes encontrados: {{ comparison_data.common_packages | length }}
      ⚙️ Serviços encontrados: {{ comparison_data.common_services | length }}
      📁 Arquivo salvo: reports/comparison_data.json
      {% else %}
      ❌ Nenhum servidor foi processado com sucesso
      🔍 Verifique se os arquivos JSON foram gerados corretamente
      {% endif %}
      
      ========================================
  delegate_to: localhost
